#!/bin/bash
# Enhanced pre-commit hook with comprehensive standards enforcement

set -euo pipefail

echo "ğŸ”’ Enhanced Standards Enforcement (v2.0)"

# 1. TypeScript Standards
echo "ğŸ” TypeScript validation..."
npm run typecheck || {
    echo "âŒ TypeScript errors detected. Fix before committing."
    exit 1
}

# 2. ESLint Standards (zero new warnings)
echo "ğŸ” ESLint validation..."
npm run lint || {
    echo "âŒ ESLint issues detected. Run 'npm run lint:fix' first."
    exit 1
}

# 3. Test Suite
echo "ğŸ” Test suite validation..."
npm run test || {
    echo "âŒ Tests failed. Fix before committing."
    exit 1
}

# 4. Environment Consistency Check
echo "ğŸ” Environment consistency..."
if ! diff -q .env .env.example > /dev/null 2>&1; then
    echo "âš ï¸  .env and .env.example structure differs"
    echo "   This is usually OK, but verify configuration consistency"
fi

# 5. Documentation Freshness
echo "ğŸ” Documentation freshness..."
if git diff --cached --name-only | grep -E "(CLAUDE\.md|src/|scripts/)" > /dev/null; then
    echo "ğŸ“ Code changes detected, updating documentation..."
    npm run docs:refresh

    # Stage the updated docs
    git add docs/ SYSTEM_MAP.md apps/fe-web/docs/
    echo "âœ… Documentation automatically updated"
fi

# 6. Standards Compliance for Shell Scripts
echo "ğŸ” Shell script standards..."
staged_shell_files=$(git diff --cached --name-only | grep '\.sh$' || true)
if [ -n "$staged_shell_files" ]; then
    echo "ğŸ”§ Checking shell scripts for standards compliance..."
    for file in $staged_shell_files; do
        if [ -f "$file" ]; then
            # Check for proper error handling
            if ! grep -q "set -" "$file"; then
                echo "âŒ $file: Missing 'set -euo pipefail' or similar"
                exit 1
            fi

            # Check for logging consistency
            if grep -q "echo" "$file" && ! grep -q "printf.*\\\033" "$file"; then
                echo "âš ï¸  $file: Consider using structured logging functions"
            fi
        fi
    done
fi

# 7. API Client Consistency Check
echo "ğŸ” API client consistency..."
if [ -f "tools/anthropic_client.sh" ] && [ -f "src/clients/anthropicAdapter.ts" ]; then
    echo "â„¹ï¸  Both shell and TypeScript API clients detected"
    echo "   Ensure they use consistent configuration and error handling"
fi

echo "âœ… All standards checks passed!"
echo "ğŸš€ Commit approved"

exit 0