#!/usr/bin/env bash
#
# Pre-push Hook - Comprehensive Checks
# Runs heavy checks before pushing to remote
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üöÄ Running comprehensive pre-push checks...${NC}"

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

FAILED=0

# 1. TypeScript Compilation (FULL)
echo -e "${BLUE}   Full TypeScript compilation...${NC}"
if npm run typecheck 2>&1 | tail -5; then
    echo -e "${GREEN}   ‚úÖ TypeScript passed${NC}"
else
    echo -e "${RED}   ‚ùå TypeScript failed${NC}"
    FAILED=1
fi

# 2. ESLint (FULL)
echo -e "${BLUE}   Full ESLint check...${NC}"
if npm run lint 2>&1 | tail -10; then
    echo -e "${GREEN}   ‚úÖ ESLint passed${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è  ESLint warnings (continuing)${NC}"
fi

# 3. Tests (FULL SUITE)
echo -e "${BLUE}   Running full test suite...${NC}"
if npm run test 2>&1 | tail -20; then
    echo -e "${GREEN}   ‚úÖ All tests passed${NC}"
else
    echo -e "${RED}   ‚ùå Tests failed${NC}"
    FAILED=1
fi

# 4. Design Validation
echo -e "${BLUE}   Design principle validation...${NC}"
if npm run design:validate >/dev/null 2>&1; then
    echo -e "${GREEN}   ‚úÖ Design principles validated${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è  Design validation warnings (continuing)${NC}"
fi

# Final result
if [ $FAILED -eq 0 ]; then
    echo -e "\n${GREEN}üéâ All pre-push checks passed! Pushing...${NC}"
    exit 0
else
    echo -e "\n${RED}üí• Pre-push checks failed!${NC}"
    echo -e "${YELLOW}Fix critical issues and try again.${NC}"
    echo -e "${BLUE}To force push (not recommended): git push --no-verify${NC}"
    exit 1
fi
