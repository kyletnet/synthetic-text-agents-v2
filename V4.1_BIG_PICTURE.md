# v4.1 Performance Maximization - Big Picture

**Date**: 2025-10-09 01:45 KST
**Status**: Phase 2.6 Implementation Starting
**Critical**: Read this for complete context before any implementation

---

## ğŸ¯ Where We Are Now

### Completed Foundation (100%)
- âœ… **Trust Infrastructure P0-P2-3**: 842/842 tests passing
  - TrustToken Layer (JWT + C2PA signature)
  - Evidence Store (audit data consistency)
  - Telemetry Interpreter (behavior â†’ insight)
  - Explanation Stability (Gate E)
  - Snapshot Logger (legal audit)

- âœ… **Design Documents**:
  - RFC 2025-16: v4 Cathedral & Forge (900+ lines)
  - RFC 2025-17: v4.1 Performance Maximization (1463 lines)
  - 4 Runbooks: LLM Timeout, Router Failure, Corpus Poisoning, Policy Conflict
  - Supporting Docs: GCG Compiler, Regulatory Packs

- âœ… **Verification**:
  - SYSTEM_VERIFICATION_REPORT.md (85% alignment with ChatGPT v4 design)
  - V4_IMPLEMENTATION_SUMMARY.md (Phase 0 complete)

### Current State (What Exists in Code)
```
âœ… src/core/trust/          # Trust Infrastructure (P0-P2-3)
âœ… src/core/transparency/   # Explanation, Evidence
âœ… src/core/telemetry/      # Behavior tracking
âœ… src/infrastructure/retrieval/  # Source Trust, BM25, Vector
âŒ src/runtime/             # NOT CREATED YET (Phase 2.6 target)
âŒ src/offline/genius-lab/  # NOT CREATED YET (Phase 2.7 target)
```

### What's NOT Implemented Yet
- âŒ 4-Layer Runtime (L1-L4)
- âŒ Quick Wins (6ê°œ)
- âŒ Genius Lab (AOL Registry, GCG Compiler, Rewards)
- âŒ Bandit/Pareto Orchestration
- âŒ Trust Console WebView

---

## ğŸš€ Strategic Direction (v4.1 Philosophy)

### Core Insight
"ìš´ì˜ íš¨ìœ¨ ë•Œë¬¸ì— ë„£ì§€ ëª»í–ˆë˜ ê³ ê¸‰ íƒìƒ‰Â·ì œì•½Â·ì¬ìˆœìœ„Â·ë³´ìƒÂ·ê²€ì¦ì„ ì´ì œ ì „ë¶€ ì¼ ë‹¤"

### Performance Targets (18 weeks)
| Metric | Baseline | Phase 2.6 | Phase 2.7 | Phase 2.8 | Phase 3.0 | Total |
|--------|----------|-----------|-----------|-----------|-----------|-------|
| Groundedness | 73% | +8% (81%) | +4% (85%) | - | - | **+12%p â†’ 85%** |
| Recall@10 | 100% | +10% (110%) | +5% (115%) | +5% (120%) | - | **+20%** |
| Readability | 100% | - | +10% (110%) | - | - | **+10%** |
| Cost/1kQA | $100 | - | -10% ($90) | -17% ($75) | - | **-25% â†’ $75** |
| Compliance | 80% | - | +10%p (90%) | - | +5%p (95%) | **+15%p â†’ 95%** |

### Top-15 Upgrades (Prioritized)
**Quick Wins (Phase 2.6, â‰¤2ì£¼)**:
1. Cross-Encoder Re-ranker â†’ Groundedness +8-12%p
2. SPLADE/ColBERT Hybrid â†’ Recall@10 +10-15%
3. Evidence-Locked Decoding â†’ Hallucination â†“
4. NLI Entailment Gate â†’ ê·¼ê±° ë¶ˆì¼ì¹˜ ì°¨ë‹¨
5. MMR/RRF Fusion â†’ ì¤‘ë³µ -20%, ë‹¤ì–‘ì„± â†‘
6. Feedback Mapping JSON â†’ í”¼ë“œë°± ë°˜ì˜ â‰¥70%

**Core Upgrades (Phase 2.7-2.8, 4-6ì£¼)**:
7. AOL Registry + GCG Compiler â†’ ì¬í˜„ì„±Â·ê°ì‚¬ì„± ê·¹ëŒ€í™”
8. Bandit + Pareto Router â†’ í’ˆì§ˆÂ·ë¹„ìš©Â·ë‹¤ì–‘ì„± ë™ì‹œ ìµœì í™”
9. Multi-View Embedding â†’ ì˜ë¯¸ê²€ìƒ‰ ê²¬ê³ ì„± â†‘
10. GPU Batched Re-ranking â†’ Throughput â†‘, Latency â†“
11. Reward Model v1 (DPO) â†’ ìì—°ì„±Â·ë…ì°½ì„± ê· í˜•
12. Corpus Merkle-DAG â†’ ë¬¸ì„œ ë¬´ê²°ì„± ê°•í™”

**Strategic (Phase 2.9-3.0, 8-12ì£¼)**:
13. Contrast Sets & Counterfactual â†’ í¸í–¥Â·ëˆ„ë½ íƒì§€
14. Federated Reward/Policy (Îµ-DP) â†’ í…Œë„ŒíŠ¸ ê°„ ì§€ëŠ¥ ê³µìœ 
15. Mutual Audit Gateway â†’ ê·œì œÂ·ì‹ ë¢° ì°¨ë³„í™”

---

## ğŸ“‹ Phase 2.6 Implementation Plan (Now â†’ 3 weeks)

### Week 1: Scaffold + Quick Wins #1-3
**Days 1-2**: Phase 2.6 Scaffold
```bash
src/runtime/
â”œâ”€â”€ l1-retrieval/           # Hybrid retrieval orchestration
â”‚   â”œâ”€â”€ hybrid-orchestrator.ts
â”‚   â”œâ”€â”€ cross-encoder-reranker.ts (Quick Win #1)
â”‚   â”œâ”€â”€ splade-adapter.ts (Quick Win #2)
â”‚   â”œâ”€â”€ fusion.ts (Quick Win #5)
â”‚   â””â”€â”€ batch-reranker.ts
â”œâ”€â”€ l2-synthesizer/         # Intent/slot extraction
â”‚   â”œâ”€â”€ intent-classifier.ts
â”‚   â”œâ”€â”€ slot-extractor.ts
â”‚   â””â”€â”€ query-rewriter.ts
â”œâ”€â”€ l3-planner/             # AOL + GCG orchestration
â”‚   â”œâ”€â”€ evidence-locked-decoder.ts (Quick Win #3)
â”‚   â”œâ”€â”€ nli-gate.ts (Quick Win #4)
â”‚   â”œâ”€â”€ operator-registry.ts
â”‚   â””â”€â”€ gcg-compiler.ts (stub)
â””â”€â”€ l4-optimizer/           # Feedback interpreter + Bandit
    â”œâ”€â”€ feedback-interpreter.ts (Quick Win #6)
    â”œâ”€â”€ bandit-policy.ts (stub)
    â””â”€â”€ pareto-router.ts (stub)
```

**Days 3-7**: Implement Quick Wins #1-3
- Cross-Encoder Re-ranker (bge-reranker-large)
- SPLADE/ColBERT Hybrid (lexical expansion)
- Evidence-Locked Decoding (constraint framework)

### Week 2: Quick Wins #4-6 + Tests
**Days 8-11**: Implement Quick Wins #4-6
- NLI Entailment Gate (DeBERTa-v3-large MNLI)
- MMR/RRF Fusion (diversity optimization)
- Feedback Mapping JSON (intentâ†’params)

**Days 12-14**: Comprehensive Testing
- Unit tests for each Quick Win (6Ã—~20 tests = ~120 tests)
- Integration tests (hybrid pipeline)
- Performance benchmarks (Recall, Groundedness)

### Week 3: Integration + KPI Validation
**Days 15-18**: System Integration
- Connect Quick Wins to existing Trust Infrastructure
- Update retrieval pipeline to use new components
- Integration with Evidence Store, TrustToken

**Days 19-21**: KPI Validation
- Measure Recall@10 improvement (+10% target)
- Measure Groundedness improvement (+8% target)
- Measure Feedback Utilization (â‰¥70% target)
- Document results in Phase 2.6 completion report

---

## ğŸ”§ Implementation Guidelines

### Critical Principles (Must Follow)
1. **No Mock Policy**: Always use real APIs, never mock implementations
2. **Feature Flag First**: All new features behind environment flags
3. **Compatibility Fallback**: Keep existing orchestration paths intact
4. **Mandatory Docs**: RFC + CHANGELOG + MIGRATION for each phase
5. **Tests Required**: 95%+ coverage, all tests must pass
6. **Adapter Pattern**: All upgrades pluggable (Registry-based)

### Dependencies to Install
```bash
# Cross-Encoder + SPLADE + NLI
npm install @xenova/transformers

# Constraint Decoding (choose one)
npm install guidance-ai  # or outlines-ai, or lmql

# Vector similarity (if not already)
npm install sentence-transformers

# Development
npm install --save-dev @types/node vitest
```

### Models to Download (Lazy Load in Production)
```bash
# Cross-Encoder
BAAI/bge-reranker-large (550MB)

# SPLADE
naver/splade-cocondenser-ensembledistil (440MB)

# NLI Gate
microsoft/deberta-v3-large-mnli (1.4GB)

# Multi-View (Phase 2.7)
BAAI/bge-m3 (2.2GB)
intfloat/e5-mistral-7b-instruct (14GB)
```

### Code Quality Gates (All Must Pass)
```bash
npm run typecheck   # Zero TypeScript errors
npm run lint        # Zero new ESLint errors
npm test            # 95%+ coverage
npm run build       # Clean build
```

---

## ğŸ“Š Success Criteria (Phase 2.6 Complete)

### Technical KPIs
- [ ] **Recall@10**: +10% improvement (baseline â†’ 110%)
- [ ] **Groundedness**: +8% improvement (73% â†’ 81%)
- [ ] **Feedback Utilization**: â‰¥70%
- [ ] **Intent Classification Accuracy**: â‰¥85%
- [ ] **NLI Gate Entailment Rate**: â‰¥90%

### Code Quality
- [ ] **Tests**: 800+ passing (from 842)
- [ ] **Coverage**: â‰¥95%
- [ ] **TypeScript**: Zero errors
- [ ] **ESLint**: Zero new warnings

### Architecture
- [ ] **4-Layer Runtime**: All layers operational
- [ ] **Quick Wins**: All 6 implemented and integrated
- [ ] **Adapter Pattern**: All components registry-based
- [ ] **Backward Compatibility**: Existing paths work

### Documentation
- [ ] **Phase 2.6 Completion Report**: KPI measurements documented
- [ ] **CHANGELOG.md**: Updated with Phase 2.6 changes
- [ ] **MIGRATION.md**: Environment variables documented
- [ ] **API Docs**: New modules documented

---

## ğŸ¯ Next Immediate Actions (Start Here)

### Step 1: Create Phase 2.6 Scaffold (30 minutes)
```bash
cd /Users/kyle/synthetic-text-agents-v2

# Create directories
mkdir -p src/runtime/{l1-retrieval,l2-synthesizer,l3-planner,l4-optimizer}

# Create config directory
mkdir -p configs/feedback

# Create test directories
mkdir -p tests/runtime/{l1-retrieval,l2-synthesizer,l3-planner,l4-optimizer}
```

### Step 2: Implement Quick Win #1 - Cross-Encoder (Day 1)
```bash
# Read RFC section
cat docs/RFC/2025-17-v4.1-performance-maximization.md | grep -A 50 "Cross-Encoder"

# Create file
touch src/runtime/l1-retrieval/cross-encoder-reranker.ts

# Implement (copy code from RFC lines 72-116)
# Test
npm test -- cross-encoder
```

### Step 3: Implement Quick Win #2 - SPLADE (Day 2)
```bash
# Create file
touch src/runtime/l1-retrieval/splade-adapter.ts

# Implement (copy code from RFC lines 146-199)
# Test
npm test -- splade
```

### Step 4: Continue Quick Wins #3-6 (Days 3-14)
Follow RFC 2025-17 implementation guide sequentially.

---

## ğŸ” How to Continue After Session Ends

### If Session Interrupted
1. **Read this file first**: `V4.1_BIG_PICTURE.md`
2. **Check RFC**: `docs/RFC/2025-17-v4.1-performance-maximization.md`
3. **Check Handoff**: `V4.1_EXECUTION_HANDOFF.md`
4. **Check git status**: `git status` (see what's been modified)
5. **Check tests**: `npm test` (see what's passing)

### If Confused About Next Step
```bash
# Check current progress
cat V4.1_BIG_PICTURE.md | grep "TODO"

# Check test status
npm test -- --reporter=verbose | grep FAIL

# Check RFC implementation order
cat docs/RFC/2025-17-v4.1-performance-maximization.md | grep "Quick Win"
```

### If Implementation Blocked
1. **Check existing code**: `src/infrastructure/retrieval/` has working examples
2. **Check RFC examples**: RFC 2025-17 has complete code samples
3. **Check baseline**: RFC 2025-16 has v4 baseline architecture
4. **Ask for help**: Create GitHub issue or check docs

---

## ğŸ“ˆ Progress Tracking (Updated Daily)

### Phase 2.6 Progress (Week 1)
- [ ] Day 1: Scaffold created
- [ ] Day 2: Cross-Encoder implemented
- [ ] Day 3: SPLADE implemented
- [ ] Day 4: Evidence-Locked implemented
- [ ] Day 5-7: Integration testing

### Phase 2.6 Progress (Week 2)
- [ ] Day 8-9: NLI Gate implemented
- [ ] Day 10-11: MMR/RRF implemented
- [ ] Day 12: Feedback Mapping created
- [ ] Day 13-14: Unit tests complete

### Phase 2.6 Progress (Week 3)
- [ ] Day 15-18: System integration
- [ ] Day 19-21: KPI validation
- [ ] Day 21: Phase 2.6 completion report

---

## ğŸš¨ Critical Reminders

### DO
- âœ… Follow RFC 2025-17 implementation order exactly
- âœ… Use Adapter/Registry pattern for all components
- âœ… Write tests BEFORE marking implementation complete
- âœ… Measure KPIs AFTER each Quick Win
- âœ… Update this file with daily progress

### DON'T
- âŒ Skip tests (mandatory for every component)
- âŒ Mock implementations (always use real APIs)
- âŒ Break existing Trust Infrastructure (P0-P2-3)
- âŒ Implement all 15 upgrades at once (incremental only)
- âŒ Commit without running quality gates

---

## ğŸ’¡ Strategic Vision (Reminder)

**From**: Feature-driven AI platform
**To**: Trust Infrastructure Company with maximum performance

**Market Position**: "The only AI platform with verifiable trust AND industry-leading accuracy"

**Competitive Moat**:
- Trust Infrastructure (P0-P2-3) â† **Already complete**
- Performance Maximization (Top-15) â† **Starting now (Phase 2.6)**
- Regulatory Compliance (HIPAA/SOX) â† **Phase 2.9**
- Mutual Audit Gateway â† **Phase 3.0**

---

**Status**: âœ… Ready to Start Phase 2.6 Implementation
**Next Action**: Create Phase 2.6 Scaffold (30 minutes)
**Last Updated**: 2025-10-09 01:45 KST

---

## ğŸ”— Quick Reference Links

- **RFC 2025-17**: `docs/RFC/2025-17-v4.1-performance-maximization.md`
- **RFC 2025-16**: `docs/RFC/2025-16-v4-hardening-and-operator-registry.md`
- **Handoff**: `V4.1_EXECUTION_HANDOFF.md`
- **Trust Infra**: `docs/TRUST_INFRASTRUCTURE.md`
- **System Philosophy**: `CLAUDE.md`

---

**Let's Build! ğŸš€**
