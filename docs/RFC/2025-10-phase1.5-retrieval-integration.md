# RFC: Phase 1.5 - Retrieval Integration

**Status**: Draft
**Created**: 2025-10-08
**Owner**: System Architecture Team

## Purpose

Integrate Retrieval layer into runtime with:
- Port/Adapter pattern (DDD)
- Hybrid search (BM25 + Vector)
- Trust scoring & Poisoning Guard
- RAGAS evaluation metrics
- Feature flags for safe rollout

## Motivation

**Current State**:
- RAG basics exist (`src/rag/`) but isolated
- No domain Port abstraction
- No trust/security layer
- No RAGAS metrics
- Missing Gate P (Retrieval Poisoning)

**Problems**:
- Retrieval not integrated with Governance/Feedback
- No source trust scoring
- Vulnerable to retrieval poisoning
- No evaluation metrics (Recall@K, MRR, Groundedness)

**Solution**:
- RetrievalPort V1 (frozen interface)
- Adapters: BM25/Vector/Hybrid
- SourceTrust + PoisoningGuard
- RAGAS bridge (Feature Flag)
- Gate P for security

## Design

### Architecture Layers

```
┌─────────────────────────────────────────┐
│  Domain Layer                           │
│  ┌───────────────────────────────────┐  │
│  │  RetrievalPort (V1 - FROZEN)      │  │
│  │  - retrieve(query, topK, filters) │  │
│  │  - batchRetrieve(...)             │  │
│  │  - stats()                        │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
            ↓ implements
┌─────────────────────────────────────────┐
│  Infrastructure Layer                   │
│  ┌─────────────┬─────────────┬────────┐ │
│  │ BM25Adapter │VectorAdapter│ Hybrid │ │
│  └─────────────┴─────────────┴────────┘ │
│         ↓                                │
│  ┌──────────────────────────────────┐   │
│  │  HybridOrchestrator              │   │
│  │  - weightedMix(α·BM25 + β·Vec)   │   │
│  └──────────────────────────────────┘   │
│         ↓                                │
│  ┌──────────────┬──────────────────┐    │
│  │ SourceTrust  │ PoisoningGuard   │    │
│  │ - domain     │ - allowlist      │    │
│  │ - signature  │ - forbidden      │    │
│  │ - timestamp  │ - hash check     │    │
│  │ - author     │ - pattern detect │    │
│  └──────────────┴──────────────────┘    │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│  Evaluation Layer                       │
│  ┌───────────────────────────────────┐  │
│  │  RAGAS Bridge (Feature Flag)      │  │
│  │  - Recall@K, MRR                  │  │
│  │  - Groundedness, Faithfulness     │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### Component Specifications

#### 1. RetrievalPort (V1 - Frozen)

```typescript
interface RetrievalPort {
  version: 1;

  retrieve(
    query: string,
    options: RetrievalOptions
  ): Promise<RetrievalResult>;

  batchRetrieve(
    queries: string[],
    options: RetrievalOptions
  ): Promise<RetrievalResult[]>;

  stats(): RetrievalStats;
}

interface RetrievalOptions {
  topK?: number;
  filters?: RetrievalFilters;
  strategy?: "bm25" | "vector" | "hybrid";
  trustThreshold?: number;
}

interface RetrievalResult {
  chunks: ScoredChunk[];
  metadata: {
    strategy: string;
    duration: number;
    totalCandidates: number;
    trustScores: TrustScore[];
  };
}
```

#### 2. HybridOrchestrator

```typescript
class HybridOrchestrator implements RetrievalPort {
  private bm25: BM25Adapter;
  private vector: VectorAdapter;
  private weights: { alpha: number; beta: number }; // α·BM25 + β·Vector

  async retrieve(query, options) {
    const bm25Results = await this.bm25.retrieve(query, options);
    const vectorResults = await this.vector.retrieve(query, options);

    // Weighted fusion
    const fused = this.fuseResults(bm25Results, vectorResults);

    // Apply trust + poisoning guard
    const trusted = await this.applyTrustFilter(fused);

    return trusted;
  }
}
```

#### 3. SourceTrust

```typescript
interface TrustScore {
  chunkId: string;
  score: number; // 0-1
  factors: {
    domainTrust: number;    // whitelisted domain
    signatureValid: boolean; // cryptographic signature
    timeFreshness: number;   // age penalty
    authorReputation: number; // author trust
  };
}

class SourceTrust {
  scoreChunk(chunk: Chunk): TrustScore {
    // Domain: +0.4 if whitelisted
    // Signature: +0.3 if valid
    // Time: decay (1.0 → 0.7 over 1 year)
    // Author: +0.3 if known good
  }
}
```

#### 4. PoisoningGuard

```typescript
interface PoisonCheck {
  passed: boolean;
  blocked: string[];
  warnings: string[];
}

class PoisoningGuard {
  private allowlist: Set<string>;
  private forbiddenPatterns: RegExp[];

  check(chunk: Chunk): PoisonCheck {
    // 1. Domain allowlist
    // 2. Forbidden keyword patterns
    // 3. Document hash verification
    // 4. Anomaly detection (sudden topic shift)
  }
}
```

#### 5. RAGAS Bridge (Feature Flag)

```typescript
interface RAGASMetrics {
  recallAtK: number[];      // [R@1, R@5, R@10]
  mrr: number;              // Mean Reciprocal Rank
  groundedness: number;     // 0-1
  faithfulness: number;     // 0-1
}

class RAGASBridge {
  async evaluate(
    queries: string[],
    retrieved: RetrievalResult[],
    groundTruth: GroundTruth[]
  ): Promise<RAGASMetrics> {
    // Feature Flag: FEATURE_RAGAS_EVAL
    if (!process.env.FEATURE_RAGAS_EVAL) return null;

    // Compute metrics
  }
}
```

### Gate Expansion

**Gate I (Source Trust) - Enhanced**:
```typescript
{
  id: "gate-i-source-trust",
  check: (results) => {
    const avgTrust = mean(results.metadata.trustScores.map(t => t.score));
    return avgTrust >= 0.6; // Threshold: 60%
  },
  severity: "P1"
}
```

**Gate P (Retrieval Poisoning) - New**:
```typescript
{
  id: "gate-p-retrieval-poisoning",
  check: (results) => {
    const poisoned = results.chunks.filter(c => !c.poisonCheck.passed);
    return poisoned.length === 0;
  },
  severity: "P0"
}
```

## Implementation Plan

### Week 1: Foundation (Low Risk)

**Day 1-2**: RetrievalPort + Adapters
- [ ] `src/domain/ports/retrieval-port.ts` (V1 frozen)
- [ ] `src/infrastructure/retrieval/bm25-adapter.ts`
- [ ] `src/infrastructure/retrieval/vector-adapter.ts`
- [ ] Unit tests (≥90%)

**Day 3-4**: Trust & Security
- [ ] `src/infrastructure/retrieval/source-trust.ts`
- [ ] `src/infrastructure/retrieval/poisoning-guard.ts`
- [ ] Integration tests

**Day 5**: Hybrid Orchestrator
- [ ] `src/infrastructure/retrieval/hybrid-orchestrator.ts`
- [ ] Feature Flag: `FEATURE_HYBRID_RETRIEVAL` (default: false)
- [ ] E2E test

### Week 2: Metrics & Gates

**Day 1-2**: RAGAS Bridge
- [ ] `src/application/evaluation/ragas-bridge.ts`
- [ ] Feature Flag: `FEATURE_RAGAS_EVAL` (default: false)
- [ ] Metrics report: `reports/retrieval-metrics.json`

**Day 3**: Gate Expansion
- [ ] Update Gate I (Source Trust floor)
- [ ] Add Gate P (Poisoning check)
- [ ] `scripts/guard.ts` integration

**Day 4-5**: Evidence Viewer (WebView prep)
- [ ] Evidence snippet component
- [ ] Trust badge UI
- [ ] Feedback button ("근거 부적절")

## Rollout Strategy

### Canary (10% → 50% → 100%)

**Phase 1 (10%)**: Internal testing
- Feature Flags: OFF (manual enable for tests)
- Metrics collection only
- No production impact

**Phase 2 (50%)**: Canary
- Enable `FEATURE_HYBRID_RETRIEVAL=true` for 50% traffic
- Monitor Recall@K, MRR, Trust scores
- Alert if degradation > 5%

**Phase 3 (100%)**: Full rollout
- Enable for all traffic
- RAGAS evaluation on sample (1%)

## Success Criteria

### Performance
- **Recall@10**: +10~20% improvement
- **MRR**: +10~20% improvement
- **Latency p95**: ≤ 3.1s (maintained)

### Quality
- **Groundedness**: +8~15%p
- **Faithfulness**: +8~15%p
- **Trust Score Avg**: ≥ 0.6

### Security
- **Gate P FAIL**: 0% (production)
- **Poisoned docs blocked**: 100%

### Cost
- **Cost/1kQA**: ≤ target (maintained or improved)
- **Embedding cache hit rate**: ≥ 70%

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Retrieval drift (freshness) | Medium | Policy Watchdog monitors corpus hash |
| Duplicate chunks | Low | MMR re-ranking (Phase 2.1) |
| Chunking quality | Medium | Document type-specific chunkers |
| License/copyright | High | 200-char snippet limit + source link |
| PII exposure | High | DLP filter + PII masking |

## Metrics & Monitoring

**reports/retrieval-metrics.json**:
```json
{
  "timestamp": "2025-10-08T10:30:00Z",
  "strategy": "hybrid",
  "recallAt10": 0.85,
  "mrr": 0.72,
  "groundedness": 0.88,
  "faithfulness": 0.91,
  "avgTrustScore": 0.74,
  "poisonedBlocked": 3,
  "cacheHitRate": 0.73
}
```

**reports/evidence-trust.jsonl**:
```jsonl
{"chunkId":"doc1-chunk3","trustScore":0.82,"domain":"trusted.com","signature":"valid","timestamp":"2025-01-15"}
{"chunkId":"doc2-chunk1","trustScore":0.45,"domain":"unknown.com","signature":"none","timestamp":"2024-06-10"}
```

## Open Questions

1. **Vector model selection**: Which embedding model? (e.g., text-embedding-3-small, voyage-2)
2. **Hybrid weights**: Start with α=0.5, β=0.5 or tune via AB test?
3. **Trust threshold**: 0.6 vs 0.7? Conservative start?
4. **RAGAS sample rate**: 1% vs 10%?

## References

- Phase 0-1 Docs: `docs/PHASE_*.md`
- Governance Rules: `governance-rules.yaml`
- Existing RAG: `src/rag/`
- Gates Spec: `src/domain/preflight/gating-rules.ts`

## Approval

- [ ] Technical Review
- [ ] Security Review
- [ ] Product Review
- [ ] Go/No-Go (11 items)
